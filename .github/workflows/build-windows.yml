name: Build Windows

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      upload_artifacts:
        description: 'Upload build artifacts'
        required: false
        default: 'true'
        type: boolean

  # Tag æ¨é€è§¦å‘ (v1.0.0, v2.1.3 ç­‰)
  push:
    tags:
      - 'v*'

  # Pull Request è§¦å‘ (ä»…æµ‹è¯•æ„å»ºï¼Œä¸ä¸Šä¼ )
  pull_request:
    branches:
      - main

# å–æ¶ˆåŒä¸€åˆ†æ”¯/æ ‡ç­¾çš„é‡å¤è¿è¡Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# æƒé™é…ç½®ï¼ˆåˆ›å»º Release å¿…é¡»ï¼‰
permissions:
  contents: write

jobs:
  build:
    name: Build for Windows x64
    runs-on: windows-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œä¾¿äºç‰ˆæœ¬æ ‡è®°

      # 2. è®¾ç½® Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      # 3. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: npm ci

      # 4. é…ç½®ç¯å¢ƒå˜é‡
      - name: Setup environment variables
        shell: pwsh
        run: |
          # åˆ›å»º .env æ–‡ä»¶ï¼ˆç”Ÿäº§æ„å»ºæ‰€éœ€çš„æœ€å°é…ç½®ï¼‰
          @"
          NODE_ENV=production
          PROJECTS_DIR=./data/projects
          PORT=3000
          WEB_PORT=3000
          PREVIEW_PORT_START=3100
          PREVIEW_PORT_END=3999
          DATABASE_URL="file:./data/prod.db"
          "@ | Out-File -FilePath .env -Encoding utf8

          # å¦‚æœéœ€è¦ API Keyï¼ˆä» GitHub Secrets è¯»å–ï¼‰
          # Add-Content -Path .env -Value "ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}"

      # 5. ç±»å‹æ£€æŸ¥
      - name: TypeScript type check
        run: npm run type-check

      # 5.5 Build Git Runtime
      - name: Cache Git Runtime
        id: cache-git-runtime
        uses: actions/cache@v4
        with:
          path: git-runtime/win32-x64
          key: git-runtime-win32-x64-2.47.1-${{ hashFiles('scripts/build-git-runtime.ps1') }}

      - name: Build Git Runtime
        if: steps.cache-git-runtime.outputs.cache-hit != 'true'
        shell: pwsh
        run: .\scripts\build-git-runtime.ps1

      - name: Verify Git Runtime
        shell: pwsh
        run: |
          $gitExe = "git-runtime\win32-x64\cmd\git.exe"
          $bashExe = "git-runtime\win32-x64\bin\bash.exe"
          $licenseFile = "git-runtime\win32-x64\THIRD_PARTY_LICENSES\git-for-windows-LICENSE.txt"

          if (-not (Test-Path $gitExe)) {
            Write-Error "git.exe not found"
            exit 1
          }
          if (-not (Test-Path $bashExe)) {
            Write-Error "bash.exe not found"
            exit 1
          }
          if (-not (Test-Path $licenseFile)) {
            Write-Error "License file not found"
            exit 1
          }

          $version = & $gitExe --version
          Write-Host "âœ… Git Runtime verification passed: $version"

      # 5.1 è°ƒè¯•ï¼šæ£€æŸ¥è„šæœ¬æ–‡ä»¶çŠ¶æ€
      - name: Debug - Inspect script file
        shell: pwsh
        run: |
          Write-Host "=== Script File Info ===" -ForegroundColor Cyan
          Get-FileHash .\tools\build-windows.ps1
          Write-Host "Line count: $((Get-Content .\tools\build-windows.ps1).Count)"
          Write-Host ""
          Write-Host "=== First 5 lines ===" -ForegroundColor Cyan
          Get-Content .\tools\build-windows.ps1 -TotalCount 5
          Write-Host ""
          Write-Host "=== Lines 350-370 (suspicious area) ===" -ForegroundColor Cyan
          $lines = Get-Content .\tools\build-windows.ps1
          350..370 | ForEach-Object { "{0,4}: {1}" -f $_, $lines[$_-1] }

      # 5.2 Parser é¢„æ£€ï¼šæ‰¾å‡ºçœŸæ­£çš„ç¬¬ä¸€ä¸ªè¯­æ³•é”™è¯¯
      - name: Parse build-windows.ps1 (PowerShell parser)
        shell: pwsh
        run: |
          $tokens = $null
          $errors = $null
          [System.Management.Automation.Language.Parser]::ParseFile("$PWD\tools\build-windows.ps1", [ref]$tokens, [ref]$errors) | Out-Null
          if ($errors.Count -gt 0) {
            Write-Host "Found $($errors.Count) parse error(s):" -ForegroundColor Red
            $errors | ForEach-Object {
              Write-Host "ParseError: $($_.Message) at $($_.Extent.StartLineNumber):$($_.Extent.StartColumnNumber)" -ForegroundColor Yellow
              Write-Host ">> $($_.Extent.Text)" -ForegroundColor Gray
              Write-Host ""
            }
            exit 1
          }
          Write-Host "Parse OK - No syntax errors found" -ForegroundColor Green

      # 6. æ‰§è¡Œ Windows æ‰“åŒ…è„šæœ¬
      - name: Build Windows package
        shell: pwsh
        run: .\tools\build-windows.ps1 -SkipTypeCheck

      # 7. æ£€æŸ¥æ„å»ºäº§ç‰©
      - name: List build artifacts
        shell: pwsh
        run: |
          Write-Host "=== Build artifacts ===" -ForegroundColor Cyan
          Get-ChildItem dist -Filter *.exe | ForEach-Object {
            $sizeMB = [math]::Round($_.Length / 1MB, 2)
            Write-Host "  - $($_.Name) (${sizeMB} MB)" -ForegroundColor White
          }

      # 8. ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload artifacts
        # ä»…åœ¨ä»¥ä¸‹æƒ…å†µä¸Šä¼ ï¼š
        # - æ‰‹åŠ¨è§¦å‘ä¸”å‹¾é€‰äº†ä¸Šä¼ 
        # - Tag æ¨é€
        if: |
          (github.event_name == 'workflow_dispatch' && github.event.inputs.upload_artifacts == 'true') ||
          startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: goodable-windows-x64-${{ github.ref_name }}
          path: |
            dist/*.exe
            dist/*.blockmap
            dist/*.yaml
          retention-days: 3
          compression-level: 6

      # 9. å‘å¸ƒåˆ° GitHub Release (ä»… Tag æ¨é€)
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.exe
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 10. æ‰“å°æ„å»ºæ€»ç»“
      - name: Build summary
        if: always()
        shell: pwsh
        run: |
          $summary = @"
          ### ğŸ‰ Build Summary

          - **Platform**: Windows x64
          - **Node Version**: $(node -v)
          - **Trigger**: ${{ github.event_name }}
          - **Ref**: ${{ github.ref }}

          "@
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value $summary

          if (Test-Path "dist") {
            $artifacts = @"
          #### ğŸ“¦ Build Artifacts
          ``````
          "@
            Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value $artifacts

            Get-ChildItem dist -Filter *.exe | ForEach-Object {
              $sizeMB = [math]::Round($_.Length / 1MB, 2)
              $line = "$($_.Name) - ${sizeMB} MB"
              Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value $line
            }

            Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value '```'
          }
